#mjt_trajectory_reset("${UNIQUE_ID}")

movej(${TRAJECTORY_FIRST_WAYPOINT})

mjt_current_time = 0.0001  # slightly larger than 0 to avoid float errors
mjt_execution_time = mjt_trajectory_execution_time("${UNIQUE_ID}")
u = mjt_trajectory_eval_time("${UNIQUE_ID}", mjt_current_time)

thread mythread():
  while (mjt_current_time < mjt_execution_time):
    servoj([u[0], u[1], u[2], u[3], u[4], u[5]], 0, 0, 0.008, 0.03, 3000)
  end
end

mythreadvar = run mythread()
sync() # give the control to the scheduler to create the new thread.

while mjt_current_time < mjt_execution_time:
  # This xmlrpc call should take less than 8ms.
  # https://forum.universal-robots.com/t/semaphore-or-mutex/672/2
  # Note though that only sync/sleep/move commands (commands that use "physical
  # time" as the manual puts it) are points where your thread can yield to
  # other threads. That means that in many cases you donâ€™t really need critical
  # sections and you can simply use global variables to synchronize between
  # threads.
  u = mjt_trajectory_eval_time("${UNIQUE_ID}", mjt_current_time)
  mjt_current_time = mjt_current_time + 0.008
end
kill mythreadvar
sync()

stopj(${TRAJECTORY_MAX_ACCELERATION})
movej(${TRAJECTORY_LAST_WAYPOINT})

